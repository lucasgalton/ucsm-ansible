---
# Example Playbook: VLAN configuration using the [ucs] hosts group
- hosts: ucs
  connection: local
  vars:
    uri_rhs: &uri_rhs
      user: "{{ rhs.username }}"
      password: "{{ rhs.password }}"
      validate_certs: no
      force_basic_auth: yes
    ucs_credentials: &ucs_credentials
      hostname: "{{ inventory_hostname }}"
      username: "{{ username | default(omit) }}"
      password: "{{ password }}"
    loop_wanted_node: &loop_wanted_node
      loop: "{{ wanted_nodes|flatten(levels=1) }}"
      loop_control:
        label: "{{ item.name }}"
    rhs_hostgroup: {}
    rhs_subnet: {}
    rhs_location: {}
    rhs_organization: {}
    rhs_environment: {}

  tasks:
    - name: Create service profile from template
      ucs_service_profile_from_template:
        <<: *ucs_credentials
        name: "{{ item.name }}"
        source_template: ceph-node
      <<: *loop_wanted_node

    - name: Gather facts about services profiles
      ucs_service_profile_info:
        <<: *ucs_credentials

    - name: Get host groups
      uri:
        <<: *uri_rhs
        method: GET
        url: "{{ rhs.url }}/api/hostgroups?search=name%3D%22{{ item.hostgroup|urlencode() }}%22"
      register: rhs_hostgroups_response
      <<: *loop_wanted_node

    - name: Save host groups IDs
      set_fact:
        rhs_hostgroup: "{{ rhs_hostgroup | combine({item.item.name : item.json.results[0].id}) }}"
      loop: "{{ rhs_hostgroups_response.results|flatten(levels=1) }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Get location ID
      uri:
        <<: *uri_rhs
        method: GET
        url: "{{ rhs.url }}/api/locations?search=name%3D%22{{ item.location|urlencode() }}%22"
      register: rhs_locations_response
      <<: *loop_wanted_node

    - name: Save location id
      set_fact:
        rhs_location: "{{ rhs_location | combine({item.item.name : item.json.results[0].id}) }}"
      loop: "{{ rhs_locations_response.results|flatten(levels=1) }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Get organization ID
      uri:
        <<: *uri_rhs
        method: GET
        url: "{{ rhs.url }}/api/organizations?search=name%3D%22{{ item.organization|urlencode() }}%22"
      register: rhs_organizations_response
      <<: *loop_wanted_node

    - name: Save organization id
      set_fact:
        rhs_organization: "{{ rhs_organization | combine({item.item.name : item.json.results[0].id}) }}"
      loop: "{{ rhs_organizations_response.results|flatten(levels=1) }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Get environment ID
      uri:
        <<: *uri_rhs
        method: GET
        url: "{{ rhs.url }}/api/environments?search=name%3D%22{{ item.environment|urlencode() }}%22"
      register: rhs_environments_response
      <<: *loop_wanted_node

    - name: Save environment id
      set_fact:
        rhs_environment: "{{ rhs_environment | combine({item.item.name : item.json.results[0].id}) }}"
      loop: "{{ rhs_environments_response.results|flatten(levels=1) }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Get subnet IDs
      uri:
        <<: *uri_rhs
        method: GET
        url: "{{ rhs.url }}/api/subnets?search=name%3D%22{{ item.1.rhs_subnet|urlencode() }}%22"
      register: rhs_subnets_response
      loop: "{{ wanted_nodes | subelements('nics') }}"
      loop_control:
        label: "{{ item.0.name }}"

    - name: Save subnet id
      set_fact:
        rhs_subnet: "{{ rhs_subnet | combine({item.json.results[0].name : item.json.results[0].id}) }}"
      loop: "{{ rhs_subnets_response.results }}"
      loop_control:
        label: "{{ item.json.results[0].name }}"

    - name: Create NICs json
      vars:
        flat_json_var_name: "{{ item.0.name + '_' + item.1.identifier }}"
        hash: "vnic{{ flat_json_var_name | hash('md5') }}"
        base_attributes: "{{ item.1.rhs_attributes | default({}) }}"
        subnet: "{{ {'subnet_id' : rhs_subnet[ item.1.rhs_subnet ]} }}"
        mac: "{{ {'mac' : ucs_sp[ item.0.name ].vnics[item.1.ucs_name].addr } }}"
        rhs_attributes: "{{ base_attributes | combine(subnet, mac) }}"
      set_fact:
        "{{ hash }}": "{{ rhs_attributes }}"
      loop: "{{ wanted_nodes | subelements('nics') }}"

    - name: Debug
      vars:
        flat_json_var_name: "{{ item.0.name + '_' + item.1.identifier }}"
        hash: "vnic{{ flat_json_var_name | hash('md5') }}"
      debug:
        var: "{{ hash }}"
      loop: "{{ wanted_nodes | subelements('nics') }}"

    - name: Debug
      debug:
        var: ucs_sp['ceph-osd-1'].vnics['TOOLS_PROV_PRIV']

#    - name: Create host in RHS
#      uri:
#        <<: *uri_rhs
#        method: POST
#      <<: *loop_wanted_node
